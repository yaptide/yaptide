FROM python:3.10-slim

# expose port to run Flask
EXPOSE 6000

# set environment variables
ENV FLASK_APP=yaptide.application
WORKDIR /usr/local/app

# install dependencies
COPY ./requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

# copy project
COPY yaptide ./yaptide

# Health check using Python and requests, we are not using curl or wget as they are not installed by default
HEALTHCHECK --interval=10s --timeout=5s --start-period=3s --retries=5 \
  CMD python -c "import requests; exit(0) if requests.get('http://localhost:6000/').ok else exit(1)"

# Health check for 'flask routes'
HEALTHCHECK --interval=5s --timeout=5s --start-period=3s --retries=5 \
  CMD flask routes || exit 1

# Run Flask app
ENTRYPOINT ["flask", "run", "--host=0.0.0.0", "--port=6000"]
