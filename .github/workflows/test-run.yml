# A basic CI workflow that tests if the app works and then deploys it on an openstack machine

name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # Get repository
      - name: Checkout
        uses: actions/checkout@v2
      
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"
          
      #install requirements.txt
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt

      #run pytest unit tests
      - name: Run main tests
        run: pytest

  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    steps:
      #get the repo
      - name: Checkout
        uses: actions/checkout@v2
        
      #add secret to ssh-agent (the key secret cannot be directly supplied to scp command since it requires a file containig the key, not the key itself)
      #the ssh-agent action adds the key to the ssh-agent on the ubuntu machine that executes this workflow without the need to write the key to a file
      - name: Add key to ssh-agent
        uses: webfactory/ssh-agent@v0.5.3
        with: 
          ssh-private-key: ${{ secrets.DEPLOY_C3_TEST }}

      #send it to the openstack machine via scp
      - name: Copy files to machine
        # if: github.ref == 'refs/heads/master'
        run: |
          scp -oProxyJump="ubuntu@149.156.182.181" -r ..\yaptide ubuntu@30.30.30.8:~

      - name: Build and run the app via ssh
        # if: github.ref == 'refs/heads/master'
        uses: appleboy/ssh-action@master
        with:
          host: ubuntu@30.30.30.8
          key: ${{ secrets.DEPLOY_C3_TEST }}
          proxy_host: ubuntu@149.156.182.181
          script: |
            cd /yaptide
            python3 -m venv env
            source env/bin/activate
            python3 -m pip install --upgrade pip
            pip3 install -r requirements.txt
            FLASK_ENV=dev FLASK_APP=yaptide.application flask run
