# A basic CI workflow that tests if the app works and then deploys it on an openstack machine

name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # Get repository
      - name: Checkout
        uses: actions/checkout@v2
      
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"
          
      #install requirements.txt
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt

      #run pytest unit tests
      - name: Run main tests
        run: pytest

  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    steps:
      # get the repo to the github agent
      - name: Checkout
        uses: actions/checkout@v2
      
      # add keys to the SSH agent
      - uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: |
            ${{ secrets.DEPLOY_C3_TEST }}
            
      # Create the known_hosts file with the open stack machines public keys
      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H 149.156.182.181 >> ~/.ssh/known_hosts
      
      # if the flask app is already running on the openstack machine, then kill it before updating the source code
      - name: Kill flask app
        if: github.ref == 'refs/heads/master'
        uses: appleboy/ssh-action@master
        with:
          host: 30.30.30.8
          username: ubuntu
          key: ${{ secrets.DEPLOY_C3_TEST }}
          proxy_host: 149.156.182.181
          proxy_username: ubuntu
          proxy_key: ${{ secrets.DEPLOY_C3_TEST }}
          script: if pgrep flask; then pkill flask; fi
          
      # copy the new files form the github agent onto the openstack machine via proxy (inspired by: https://stackoverflow.com/questions/16654751/rsync-through-ssh-tunnel)
      - name: Copy files to the machine
        if: github.ref == 'refs/heads/master'
        run: rsync -e "ssh -A ubuntu@149.156.182.181 ssh" ./* ubuntu@30.30.30.8:~/yaptide --delete --recursive
      
      # recreate env (it was destroyed by rsync during copying)
      # enter env and install requirements
      # set flask environment to developement and specify the package containing the app factory
      # then run the app detatched using screen (inspired by: https://unix.stackexchange.com/questions/266571/remotely-starting-a-screen-session-through-ssh-and-closing-the-ssh-session-immed)
      - name: Build and run the app via ssh
        if: github.ref == 'refs/heads/master'
        uses: appleboy/ssh-action@master
        with:
          host: 30.30.30.8
          username: ubuntu
          key: ${{ secrets.DEPLOY_C3_TEST }}
          proxy_host: 149.156.182.181
          proxy_username: ubuntu
          proxy_key: ${{ secrets.DEPLOY_C3_TEST }}
          script: |
            cd yaptide
            python3 -m venv env
            source env/bin/activate
            python3 -m pip install --upgrade pip
            pip3 install -r requirements.txt
            FLASK_ENV=developement FLASK_APP=yaptide.application screen -d -m flask run
